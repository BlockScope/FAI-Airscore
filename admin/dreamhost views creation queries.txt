DROP TABLE IF EXISTS airscore_dev.tblPilot ;
DROP VIEW IF EXISTS airscore_dev.tblPilot ;
CREATE VIEW airscore_dev.tblPilot AS 
SELECT
    `U`.`ID` AS `pilPk`,
    `U`.`user_login` AS `pilLogin`,
    `U`.`user_pass` AS `pilpass`,
    `U`.`user_email` AS `pilEmail`,
    (SELECT `meta_value` FROM `legapiloti_multisite`.`wp_kdvcuk_usermeta` WHERE `user_id` = `U`.`ID` AND `meta_key` = 'first_name' LIMIT 1) AS `pilFirstName`,
    (SELECT `meta_value` FROM `legapiloti_multisite`.`wp_kdvcuk_usermeta` WHERE `user_id` = `U`.`ID` AND `meta_key` = 'last_name' LIMIT 1) AS `pilLastName`,
	(SELECT `meta_value` FROM `legapiloti_multisite`.`wp_kdvcuk_usermeta` WHERE `user_id` = `U`.`ID` AND `meta_key` = 'nazionalita' LIMIT 1) AS `pilNat`,
	(SELECT `meta_value` FROM `legapiloti_multisite`.`wp_kdvcuk_usermeta` WHERE `user_id` = `U`.`ID` AND `meta_key` = 'cellulare' LIMIT 1) AS `pilPhoneMobile`, 
	IF ( (SELECT `meta_value` FROM `legapiloti_multisite`.`wp_kdvcuk_usermeta` WHERE `user_id` = `U`.`ID` AND `meta_key` = 'sesso' LIMIT 1) IN ('Femmina', 'F', 'Female'), 'F', 'M') AS `pilSex`,
	(SELECT `meta_value` FROM `legapiloti_multisite`.`wp_kdvcuk_usermeta` WHERE `user_id` = `U`.`ID` AND `meta_key` = 'vela_marca' LIMIT 1) AS `pilGliderBrand`,
	(SELECT `meta_value` FROM `legapiloti_multisite`.`wp_kdvcuk_usermeta` WHERE `user_id` = `U`.`ID` AND `meta_key` = 'vela_modello' LIMIT 1) AS `pilGlider`,
 	(SELECT `meta_value` FROM `legapiloti_multisite`.`wp_kdvcuk_usermeta` WHERE `user_id` = `U`.`ID` AND `meta_key` = 'vela_certificazione' LIMIT 1) AS `gliGliderCert`,
    CASE
		(SELECT `meta_value` FROM `legapiloti_multisite`.`wp_kdvcuk_usermeta` WHERE `user_id` = `U`.`ID` AND `meta_key` = 'vela_certificazione' LIMIT 1)
		WHEN 'A' THEN 'Sport Class' 
		WHEN 'B' THEN 'Sport Class' 
		WHEN 'C' THEN 'Sport Class' 
		WHEN 'D' THEN 'Serial Class' 
		WHEN 'CCC' THEN 'Open Class' 
		ELSE 'Open Class' 
	END
	AS `gliGliderClass`,
	(SELECT `meta_value` FROM `legapiloti_multisite`.`wp_kdvcuk_usermeta` WHERE `user_id` = `U`.`ID` AND `meta_key` = 'sponsor' LIMIT 1) AS `pilSponsor`,
	(SELECT `meta_value` FROM `legapiloti_multisite`.`wp_kdvcuk_usermeta` WHERE `user_id` = `U`.`ID` AND `meta_key` = 'licenza_fai' LIMIT 1) AS `pilFAI`,
	(SELECT `meta_value` FROM `legapiloti_multisite`.`wp_kdvcuk_usermeta` WHERE `user_id` = `U`.`ID` AND `meta_key` = 'civl_id' LIMIT 1) AS `pilCIVL`,
	(SELECT `meta_value` FROM `legapiloti_multisite`.`wp_kdvcuk_usermeta` WHERE `user_id` = `U`.`ID` AND `meta_key` = 'user_livetrack24' LIMIT 1) AS `pilLT24User`,
	(SELECT `meta_value` FROM `legapiloti_multisite`.`wp_kdvcuk_usermeta` WHERE `user_id` = `U`.`ID` AND `meta_key` = 'user_airtribune' LIMIT 1) AS `pilATUser`,
	(SELECT `meta_value` FROM `legapiloti_multisite`.`wp_kdvcuk_usermeta` WHERE `user_id` = `U`.`ID` AND `meta_key` = 'user_xcontest' LIMIT 1) AS `pilXContestUser` 
FROM `legapiloti_multisite`.`wp_kdvcuk_users` `U`
UNION
SELECT
    `P`.`pilPk` AS `pilPk`,
    NULL AS `pilLogin`,
    NULL AS `pilPass`,
    `P`.`pilEmail` AS `pilEmail`,
    `P`.`pilFirstName` AS `pilFirstName`,
    `P`.`pilLastName` AS `pilLastName`,
    `P`.`pilNat` AS `pilNat`,
    `P`.`pilPhoneMobile` AS `pilPhoneMobile`,
    `P`.`pilSex` AS `pilSex`,
    `P`.`pilGliderBrand` AS `pilGliderBrand`,
    `P`.`pilGlider` AS `pilGlider`,
    `P`.`gliGliderCert` AS `gliGliderCert`,
    CASE 
    	`P`.`gliGliderCert` 
    	WHEN 'A' THEN 'Sport Class' 
    	WHEN 'B' THEN 'Sport Class' 
    	WHEN 'C' THEN 'Sport Class' 
    	WHEN 'D' THEN 'Serial Class' 
    	WHEN 'CCC' THEN 'Open Class' 
    	ELSE 'Open Class'
    END
	AS `gliGliderClass`,
	`P`.`pilSponsor` AS `pilSponsor`,
	`P`.`pilFAI` AS `pilFAI`,
	`P`.`pilCIVL` AS `pilCIVL`,
	`P`.`pilLT24User` AS `pilLT24User`,
	`P`.`pilATUser` AS `pilATUser`,
	`P`.`pilXcontestUser` AS `pilXcontestUser`
FROM `airscore_dev`.`tblExtPilot` `P`




DROP TABLE IF EXISTS airscore_dev.tblUser ;
DROP VIEW IF EXISTS airscore_dev.tblUser ;
CREATE VIEW airscore_dev.tblUser AS 
SELECT DISTINCT
    `U`.`ID` AS `usePk`,
    `U`.`display_name` AS `useName`,
    `U`.`user_login` AS `useLogin`,
    `U`.`user_email` AS `useEmail` 
FROM `legapiloti_multisite`.`wp_kdvcuk_users` `U` 
JOIN `legapiloti_multisite`.`wp_kdvcuk_usermeta` `M` 
ON 
	(SELECT DISTINCT `meta_value` FROM `legapiloti_multisite`.`wp_kdvcuk_usermeta` WHERE (`user_id` = `U`.`ID`) AND (`meta_key` = 'airscore_admin') LIMIT 1) = 1



CREATE VIEW airscore_dev.tblResult AS 
SELECT
    T.`tarPk`,
    T.`traPk`,
    T.`tasPk`,
    TR.`pilPk`,
    CONCAT_WS(
        ' ',
        P.`pilFirstName`,
        P.`pilLastName`
    ) AS pilName,
    P.`pilSponsor`,
    (
    SELECT
        CC.`natIso3`
    FROM
        `tblCountryCodes` CC
    WHERE
        CC.`natID` = P.`pilNat`
) AS pilNationCode,
TR.`traGlider`,
T.`tarDistance`,
T.`tarSpeed`,
T.`tarStart`,
T.`tarGoal`,
T.`tarResultType`,
T.`tarSS`,
T.`tarES`,
T.`tarTurnpoints`,
T.`tarPenalty`,
T.`tarComment`,
T.`tarPlace`,
T.`tarSpeedScore`,
T.`tarDistanceScore`,
T.`tarArrivalScore`,
T.`tarDepartureScore`,
T.`tarScore`,
T.`tarLeadingCoeff`,
T.`tarLeadingCoeff2`,
T.`tarLastAltitude`,
T.`tarLastTime`
FROM
    `tblTaskResult` T
JOIN `tblTrack` TR USING(`traPk`)
JOIN `tblPilot` P USING(`pilPk`)
UNION ALL
SELECT NULL AS
    `tarPk`,
    NULL AS `traPk`,
    T.`tasPk`,
    T.`pilPk`,
    CONCAT_WS(
        ' ',
        P.`pilFirstName`,
        P.`pilLastName`
    ) AS pilName,
    P.`pilSponsor`,
    (
    SELECT
        CC.`natIso3`
    FROM
        `tblCountryCodes` CC
    WHERE
        CC.`natID` = P.`pilNat`
) AS pilNationCode,
T.`traGlider`,
T.`tarDistance`,
T.`tarSpeed`,
T.`tarStart`,
T.`tarGoal`,
T.`tarResultType`,
T.`tarSS`,
T.`tarES`,
T.`tarTurnpoints`,
T.`tarPenalty`,
T.`tarComment`,
T.`tarPlace`,
T.`tarSpeedScore`,
T.`tarDistanceScore`,
T.`tarArrivalScore`,
T.`tarDepartureScore`,
T.`tarScore`,
T.`tarLeadingCoeff`,
T.`tarLeadingCoeff2`,
T.`tarLastAltitude`,
T.`tarLastTime`
FROM
    `tblExtResult` T
JOIN `tblPilot` P USING(`pilPk`)
ORDER BY
    `tasPk`,
    `tarScore`
DESC


CREATE VIEW airscore_dev.tblCompView AS SELECT
    C.*,
    IF(
        C.comExt = '1',
        FC.extForName,
        F.forName
    ) AS forName,
    FC.comOverallScore,
    FC.comOverallParam,
    FC.forNomGoal,
    FC.forMinDistance,
    FC.forNomDistance,
    FC.forNomTime,
    FC.forNomLaunch,
    FC.forScorebackTime,
    FC.comTeamSize,
    FC.comTeamScoring,
    FC.comTeamOver,
    IF(C.comExt <> '1', F.forPk, NULL) AS forPk,
    IF(
        C.comExt <> '1',
        F.forClass,
        NULL
    ) AS forClass,
    IF(
        C.comExt <> '1',
        F.forVersion,
        NULL
    ) AS forVersion,
    IF(
        C.comExt <> '1',
        F.forComClass,
        NULL
    ) AS forComClass
FROM
    tblCompetition C
JOIN tblForComp FC USING(comPk)
JOIN tblFormula F USING(forPk)
ORDER BY CASE WHEN
    C.comName LIKE '%test%' THEN C.comName ELSE C.comDateTo
END
DESC

CREATE VIEW airscore_dev.tblTaskView AS SELECT
    T.*,
    UPPER(
        CONCAT(
            C.comCode,
            '_',
            LEFT(T.tasName, 1),
            RIGHT(T.tasName, 1)
        )
    ) AS tasCode,
    (
    SELECT
        MAX(tblResult.tarScore)
    FROM
        tblResult
    WHERE
        tblResult.tasPk = T.tasPk
) AS maxScore,
(
    SELECT
        rwpAltitude
    FROM
        tblRegionWaypoint
    JOIN tblTaskWaypoint TW USING(rwpPk)
    WHERE
        TW.tasPk = T.tasPk AND TW.tawType = 'goal'
) AS tasGoalAlt,
C.comCode,
C.comName,
C.comDateFrom,
C.comDateTo,
C.comTimeOffset,
C.comClass,
C.comExt
FROM
    tblTask T
JOIN tblCompetition C USING(comPk)
ORDER BY
    T.tasDate
DESC
